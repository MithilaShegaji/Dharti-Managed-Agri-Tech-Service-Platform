<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Dharti</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --admin-bg: #f8f9fa;
            --panel-bg: #ffffff;
            --header-bg: #343a40;
            --text-color: #495057;
            --brand-color: #27ae60;
            --border-color: #dee2e6;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--admin-bg);
            margin: 0;
            color: var(--text-color);
        }
        .header {
            background-color: var(--header-bg);
            color: white;
            padding: 1rem 2rem;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            padding: 2rem;
            align-items: start;
        }
        .panel {
            background-color: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .panel-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }
        .panel-body {
            padding: 1.5rem;
            max-height: 65vh;
            overflow-y: auto;
        }
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 0 1.5rem;
        }
        .filters input {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        .card {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card.selected {
            border-color: var(--brand-color);
            background-color: #eafaf1;
            box-shadow: 0 0 0 2px var(--brand-color);
        }
        .card input { margin-right: 1rem; }
        .card-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 1rem;
        }
        .card-details { flex-grow: 1; }
        .card-details h4 { margin: 0 0 5px 0; }
        .card-details p { margin: 0; font-size: 0.9rem; color: #6c757d; }
        .card-details .tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .card-details .tag { background-color: #e9ecef; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; }
        
        .match-button-container {
            padding: 2rem;
            text-align: center;
        }
        #match-btn {
            padding: 1rem 3rem;
            font-size: 1.2rem;
            font-weight: 600;
            background-color: var(--brand-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #match-btn:disabled {
            background-color: #a5d6a7;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; transform: scale(0.9); transition: all 0.3s; }
        .modal-content.active { transform: scale(1); }
        .modal-content h2 { margin-top: 0; }
        .modal-summary { margin-bottom: 1.5rem; }
        .modal-summary p { margin: 0.5rem 0; }
        .modal-summary span { font-weight: 600; }
        .modal-form-group { margin-bottom: 1rem; }
        .modal-form-group label { display: block; margin-bottom: 0.5rem; }
        .modal-form-group input { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 5px; }
        .modal-actions { text-align: right; margin-top: 2rem; }
        .modal-actions button { padding: 0.75rem 1.5rem; border: none; border-radius: 5px; cursor: pointer; margin-left: 1rem; }
        #confirm-match-btn { background-color: var(--brand-color); color: white; }
        #cancel-match-btn { background-color: #6c757d; color: white; }
    </style>
</head>
<body>

    <header class="header">Dharti Admin - Project Matching</header>

    <div class="match-button-container">
        <button id="match-btn" disabled>Create Project Match</button>
    </div>

    <div class="dashboard-container">
        <div class="panel">
            <div class="panel-header"><h2>1. Select a Landowner</h2></div>
            <div class="panel-body" id="landowners-list">
                <!-- Landowner cards will be injected here by JavaScript -->
            </div>
        </div>
        <div class="panel">
            <div class="panel-header"><h2>2. Select Farmers</h2></div>
            <div class="filters">
                <input type="text" id="farmer-search" placeholder="Search by name, location, skill...">
            </div>
            <div class="panel-body" id="farmers-list">
                <!-- Farmer cards will be injected here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmation-modal">
        <div class="modal-content">
            <h2>Confirm New Project</h2>
            <div class="modal-summary">
                <h4>Landowner</h4>
                <p id="modal-landowner-name"></p>
                <h4>Assigned Farmers</h4>
                <ul id="modal-farmers-list"></ul>
            </div>
            <div class="modal-form">
                <div class="modal-form-group">
                    <label for="crop-name">Recommended Crop</label>
                    <input type="text" id="crop-name" placeholder="e.g., Soybean, Cotton" required>
                </div>
                <div class="modal-form-group">
                    <label for="start-date">Projected Start Date</label>
                    <input type="date" id="start-date" required>
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancel-match-btn">Cancel</button>
                <button id="confirm-match-btn">Confirm & Create Project</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const landownersList = document.getElementById('landowners-list');
            const farmersList = document.getElementById('farmers-list');
            const matchBtn = document.getElementById('match-btn');
            const farmerSearchInput = document.getElementById('farmer-search');
            
            // Modal elements
            const modal = document.getElementById('confirmation-modal');
            const modalContent = modal.querySelector('.modal-content');
            const modalLandownerName = document.getElementById('modal-landowner-name');
            const modalFarmersList = document.getElementById('modal-farmers-list');
            const cancelBtn = document.getElementById('cancel-match-btn');
            const confirmBtn = document.getElementById('confirm-match-btn');
            const cropInput = document.getElementById('crop-name');
            const dateInput = document.getElementById('start-date');

            let allLandowners = [];
            let allFarmers = [];
            let selectedLandownerId = null;
            let selectedFarmerIds = new Set();

            async function fetchData() {
                try {
                    const response = await fetch('/api/admin/data-for-matching');
                    if (!response.ok) throw new Error('Failed to fetch data');
                    const data = await response.json();
                    allLandowners = data.landowners;
                    allFarmers = data.farmers;
                    renderLandowners();
                    renderFarmers();
                } catch (error) {
                    console.error(error);
                    landownersList.innerHTML = '<p>Error loading data.</p>';
                    farmersList.innerHTML = '<p>Error loading data.</p>';
                }
            }

            function renderLandowners() {
                landownersList.innerHTML = '';
                allLandowners.forEach(l => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.dataset.id = l._id;
                    card.innerHTML = `
                        <input type="radio" name="landowner" value="${l._id}">
                        <div class="card-details">
                            <h4>${l.firstName} ${l.lastName || ''}</h4>
                            <p>${l.landDetails.landAddress} - <strong>${l.landDetails.landArea} ${l.landDetails.landUnit}</strong></p>
                        </div>
                    `;
                    card.addEventListener('click', () => {
                        card.querySelector('input[type="radio"]').checked = true;
                        handleLandownerSelection(l._id);
                    });
                    landownersList.appendChild(card);
                });
            }

            function renderFarmers() {
                farmersList.innerHTML = '';
                const searchTerm = farmerSearchInput.value.toLowerCase();
                const filteredFarmers = allFarmers.filter(f => 
                    `${f.firstName} ${f.lastName}`.toLowerCase().includes(searchTerm) ||
                    f.location.district.toLowerCase().includes(searchTerm) ||
                    f.skills.some(s => s.toLowerCase().includes(searchTerm))
                );

                filteredFarmers.forEach(f => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.dataset.id = f._id;
                    card.innerHTML = `
                        <input type="checkbox" value="${f._id}">
                        <div class="card-details">
                            <h4>${f.firstName} ${f.lastName || ''}</h4>
                            <p>${f.location.district}, ${f.location.state} | <strong>${f.experienceInYears} Yrs Exp.</strong></p>
                            <div class="tags">${f.skills.map(s => `<span class="tag">${s}</span>`).join('')}</div>
                        </div>
                    `;
                    card.addEventListener('click', () => {
                        const checkbox = card.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        handleFarmerSelection(f._id, checkbox.checked);
                    });
                    farmersList.appendChild(card);
                });
            }

            function handleLandownerSelection(id) {
                selectedLandownerId = id;
                document.querySelectorAll('#landowners-list .card').forEach(c => {
                    c.classList.toggle('selected', c.dataset.id === id);
                });
                updateMatchButtonState();
            }

            function handleFarmerSelection(id, isSelected) {
                if (isSelected) {
                    selectedFarmerIds.add(id);
                } else {
                    selectedFarmerIds.delete(id);
                }
                document.querySelector(`#farmers-list .card[data-id="${id}"]`).classList.toggle('selected', isSelected);
                updateMatchButtonState();
            }

            function updateMatchButtonState() {
                matchBtn.disabled = !selectedLandownerId || selectedFarmerIds.size === 0;
            }

            function showConfirmationModal() {
                const landowner = allLandowners.find(l => l._id === selectedLandownerId);
                const farmers = allFarmers.filter(f => selectedFarmerIds.has(f._id));

                modalLandownerName.textContent = `${landowner.firstName} ${landowner.lastName || ''} (${landowner.landDetails.landAddress})`;
                modalFarmersList.innerHTML = farmers.map(f => `<li>${f.firstName} ${f.lastName || ''}</li>`).join('');

                modal.classList.add('active');
                modalContent.classList.add('active');
            }

            async function handleCreateProject() {
                if (!cropInput.value || !dateInput.value) {
                    alert('Please provide crop name and start date.');
                    return;
                }

                const projectData = {
                    landownerId: selectedLandownerId,
                    farmerIds: Array.from(selectedFarmerIds),
                    crop: cropInput.value,
                    projectedStartDate: dateInput.value
                };

                try {
                    const response = await fetch('/api/admin/create-project', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(projectData)
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Failed to create project');
                    
                    alert('Project created successfully!');
                    location.reload(); // Reload the page to clear lists

                } catch (error) {
                    console.error(error);
                    alert(error.message);
                }
            }
            
            // Event Listeners
            matchBtn.addEventListener('click', showConfirmationModal);
            farmerSearchInput.addEventListener('input', renderFarmers);
            cancelBtn.addEventListener('click', () => {
                modal.classList.remove('active');
                modalContent.classList.remove('active');
            });
            confirmBtn.addEventListener('click', handleCreateProject);

            // Initial fetch
            fetchData();
        });
    </script>
</body>
</html>